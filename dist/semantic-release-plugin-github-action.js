"use strict";var l=require("node:fs"),C=require("execa");const F="action.yml",I=".ghaignore",p=".gitignore",k=".backup",R=(e,t)=>{if(!l.existsSync(e))return;let s=e+t;for(;l.existsSync(s);)s=s+t;return l.copyFileSync(e,s),s},q=(e,t)=>t.split(".").reduce((s,n)=>s?.[n],e),b=e=>{const t=new Set;for(const s of e.split(/\r?\n/)){const n=s.split("#")[0].trim();typeof n=="string"&&n!==""&&t.add(n)}return Array.from(t)},v=(e,t="")=>[...t.matchAll(/{(.*?)}/g)].map(s=>s[1]).reduce((s,n)=>{const r=q(e,n);return s.replace(`{${n}}`,`${r}`)},t),E=({branch:e,nextRelease:t})=>({branch:e.name,version:t.version,tag:t.gitTag,notes:t.notes??""}),N=(e,t)=>{const s={ghaIgnores:[],gitIgnores:[]};if(!l.existsSync(e))return s;const n=t??l.readFileSync(e,"utf8");s.ghaIgnores=b(n);const r=R(p,k);return r!==void 0&&(s.backupFile=r,s.gitIgnores=b(r),l.rmSync(p,{force:!0})),l.copyFileSync(e,p),s},O=(e="")=>{l.existsSync(e)&&(l.rmSync(p,{force:!0}),l.copyFileSync(e,p))},a=async(e,t=[])=>await C.execa("git",[e,...t]),j=(e,{force:t=!1}={})=>{const s=[];return t&&s.push("-f"),[...s,"--",e]},A=async(e,t={})=>{const s=j(e,t);return await a("add",s)},G=(e,{allowEmpty:t=!1,keyid:s,sign:n=!1}={})=>{const r=[];if(n){const c="-S",o=typeof s=="string"&&s!==""?`${c}${s}`:c;r.push(o)}return t&&r.push("--allow-empty"),[...r,"-m",`${e}`]},U=async(e,t={})=>{const s=G(e,t);return await a("commit",s)},_=(e,{get:t=!1,list:s=!1,unset:n=!1,scope:r="local",value:c}={})=>{const o=[`--${r}`];return c!=null?o.push(`${e}`,`${c.toString()}`):t?o.push("--get",`${e}`):n?o.push("--unset",`${e}`):s&&o.push("--list"),o},$=async(e,t)=>{const s=_(e,t);return await a("config",s)},B=async(e,t="local")=>{const{stdout:s}=await $(e,{get:!0,scope:t});if(s==="false")return!1;if(s==="true")return!0;const n=Number(s);return Number.isNaN(n)?s:n},M=async(e,t,s="local")=>await $(e,{scope:s,value:t}),P=(e,{tags:t=!1}={})=>{const s=[];let n="";return t===!0&&s.push("--tags"),typeof t=="string"&&(n=t),[...s,e,n]},T=async(e,t={})=>{const s=P(e,t);return await a("ls-remote",s)},W=(e,{delete:t=!1,force:s=!1,remote:n="origin",signed:r=!1}={})=>{const c=[n,e];return t?[n,"-d",e]:(s&&c.push("-f"),r!==!1&&c.push(`--signed=${r}`),c)},H=async(e,t={})=>{const s=W(e,t);return await a("push",s)},K=(e,{quiet:t=!1}={})=>{const s=[];return t&&s.push("-q"),[...s,"--",e]},L=async(e,t={})=>{const s=K(e,t);return await a("reset",s)},X=(e,{cached:t=!1,force:s=!1,ignoreUnmatch:n=!1,quiet:r=!1,recursive:c=!1}={})=>{const o=[];return s&&o.push("-f"),t&&o.push("--cached"),n&&o.push("--ignore-unmatch"),r&&o.push("-q"),c&&o.push("-r"),[...o,"--",e]},Y=async(e,t={})=>{const s=X(e,t);return await a("rm",s)},z=(e,{commit:t,delete:s=!1,force:n=!1,list:r=!1,message:c="",sign:o=!1}={})=>{if(s)return["-d",e];if(r)return e===""?["-l"]:["-l",e];const i=[];return n&&i.push("-f"),o&&i.push("-s"),i.push(e),t!==void 0&&i.push(t),[...i,"-m",`${c}`]},D=async(e,t={})=>{const s=z(e,t);return await a("tag",s)},J=e=>({value:e,enumerable:!0,configurable:!1,writable:!1}),Q=(e,t)=>{Object.keys(t).forEach(s=>{const n=J(t[s]);Object.defineProperty(e,s,n)})};Q(a,{add:A,commit:U,config:$,getConfig:B,setConfig:M,lsRemote:T,push:H,reset:L,rm:Y,tag:D});const V=e=>({value:e,enumerable:!0,configurable:!1,writable:!1}),Z=(e,t)=>{Object.keys(t).forEach(s=>{const n=V(t[s]);Object.defineProperty(e,s,n)})},g=e=>`\x1B[${e}m`,ee=g(31),se=g(32),te=g(33),ne=g(34),oe=g(37),re=g(90),ce=g(91),f=(e,t,s="\x1B[39m")=>e.split(`
`).map(n=>(n=t+n,n=n.endsWith("\r")?n.slice(0,-1)+s+"\r":n+s,n)).join(`
`),ae=e=>{console.log(f(e,ce))},ie=e=>{console.log(f(e,ee))},le=e=>{console.log(f(e,te))},ue=e=>{console.log(f(e,ne))},ge=e=>{console.log(f(e,se))},fe=e=>{console.log(f(e,re))},pe=e=>{console.log(f(e,oe))},me=e=>{console.log(e)},S=(...e)=>{console.log(...e)};Z(S,{fatal:ae,error:ie,warn:le,info:ue,success:ge,debug:fe,trace:pe,log:me});const he=S,x=async(e,t,{branch:s,message:n,sign:r,tag:c})=>{await a.add("."),console.log("removeContents:",e),console.log("addContents:",t);for(const o of e)console.log("removeContent:",o),t.includes(o)||(console.log("----------removeContent:",o),await a.rm(o,{force:!0,cached:!0,ignoreUnmatch:!0,recursive:o.endsWith("/"),quiet:!0}));for(const o of t)if(console.log("addContent:",o),!e.includes(o)){console.log("----------addContent:",o);try{await a.add(o,{force:!0})}catch(i){const u=i instanceof Error?i.message:`Uknown error from: ${i}`;he.warn(u)}}await a.commit(n,{allowEmpty:!0,sign:r}),await a.push(s),!(typeof c!="string"||c==="")&&(await a.tag(c,{force:!0,message:n,sign:r}),await a.push(c,{force:!0}))},ye=(e,t)=>{if(!l.existsSync(e))return;const s=l.readFileSync(e,"utf8").split(/\r?\n/),n=/^(\s*)version\s*:\s*([^\s#]+)(\s*)(#.*)?$/,r=/^(\s*)name\s*:\s*(.+)$/;let c=!1,o=-1;for(let u=0;u<s.length;u++){const m=s[u].match(n);if(m!=null){const[,h,,y,w]=m;s[u]=`${h}version: ${t}${y!==""?y:" "}${w!==""?w:""}`,c=!0;break}s[u].match(r)!=null&&(o=u)}if(!c){const u=`version: ${t}`;o>=0?s.splice(o+1,0,u):s.unshift(u)}const i=s.join(`
`);l.rmSync(e,{force:!0}),l.writeFileSync(e,i,"utf8")},de=async({actionFile:e=F,ignoreFile:t=I,ignoreContent:s,latestMessage:n=`latest: v{nextRelease.version}

{nextRelease.notes}`,releaseMessage:r=`release: v{nextRelease.version}

{nextRelease.notes}`,sign:c=!1}={},o)=>{const{branch:i,tag:u,version:m}=E(o),{ghaIgnores:d,gitIgnores:h,backupFile:y}=N(t,s);ye(e,m),await x(d,h,{branch:i,message:v(o,r),sign:c,tag:u}),O(y),await x(h,d,{branch:i,message:v(o,n),sign:c})};exports.publish=de;
